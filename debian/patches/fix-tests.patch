From: Debian Mono Group <pkg-mono-group@lists.alioth.debian.org>
Date: Sun, 13 Dec 2020 11:39:12 +0300
Subject: fix-tests

===================================================================
---
 mcs/errors/Makefile         | 12 +++++++++++-
 mono/tests/Makefile.am      |  5 +++++
 mono/unit-tests/Makefile.am |  8 ++++----
 3 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/mcs/errors/Makefile b/mcs/errors/Makefile
index dc1eb33..c0461cb 100644
--- a/mcs/errors/Makefile
+++ b/mcs/errors/Makefile
@@ -45,7 +45,11 @@ all-local $(STD_TARGETS:=-local):
 VALID_TEST_PROFILE := $(filter net_4_x, $(PROFILE))
 ifdef VALID_TEST_PROFILE
 
-qcheck: run-mcs-tests 
+ifdef USE_SYSTEM_MONO
+qcheck:
+else
+qcheck: run-mcs-tests
+endif
 
 run-test-local: test-local qcheck
 
@@ -111,9 +115,15 @@ dlls/second/CS1703-lib.dll: dlls/second/CS1703-lib.cs
 dlls/second/CS1705-lib.dll: dlls/second/CS1705-lib.cs
 	$(CSCOMPILE) /r:$(topdir)/class/lib/$(PROFILE_DIRECTORY)/mscorlib.dll /target:library /warn:0 /publicsign /keyfile:key.snk /out:$@ $<
 
+ifdef USE_SYSTEM_MONO
+dlls/cs1703-2/System.dll: $(system_mono_path)/2.0-api/System.dll
+	mkdir -p $(dir $@)
+	cp $< $@
+else
 dlls/cs1703-2/System.dll: $(topdir)/../external/binary-reference-assemblies/v2.0/System.dll
 	mkdir -p $(dir $@)
 	cp $< $@
+endif
 
 CS1701-lib.dll : CS1701-lib.cs dlls/first/CS1701-lib.dll
 	$(CSCOMPILE) /r:$(topdir)/class/lib/$(PROFILE_DIRECTORY)/mscorlib.dll /target:library /warn:0 /r:dlls/first/CS1701-lib.dll /out:$@ $<
diff --git a/mono/tests/Makefile.am b/mono/tests/Makefile.am
index 4c3e967..c12097b 100755
--- a/mono/tests/Makefile.am
+++ b/mono/tests/Makefile.am
@@ -2955,8 +2955,13 @@ generic-delegate2.2.exe$(PLATFORM_AOT_SUFFIX): generic-delegate2-lib.2.dll$(PLAT
 generic-delegate2.2.exe: $(srcdir)/generic-delegate2.2.cs generic-delegate2-lib.2.dll
 	$(MCS) -r:generic-delegate2-lib.2.dll -out:$@ $<
 
+if USE_SYSTEM_MONO
+bug-3903.exe: bug-3903.cs
+	$(MCS_NO_LIB)  $(srcdir)/bug-3903.cs -nostdlib -r:$(system_mono_path)/2.0-api/mscorlib.dll -r:$(system_mono_path)/2.0-api/System.Core.dll -out:$@
+else
 bug-3903.exe: bug-3903.cs
 	$(MCS_NO_LIB)  $(srcdir)/bug-3903.cs -nostdlib -r:$(srcdir)/../../external/binary-reference-assemblies/v2.0/mscorlib.dll -r:$(srcdir)/../../external/binary-reference-assemblies/v2.0/System.Core.dll -out:$@
+endif
 
 EXTRA_DIST += appdomain-marshalbyref-assemblyload-MidAssembly.cs appdomain-marshalbyref-assemblyload-LeafAssembly.cs
 
diff --git a/mono/unit-tests/Makefile.am b/mono/unit-tests/Makefile.am
index 85fff69..a21af8b 100644
--- a/mono/unit-tests/Makefile.am
+++ b/mono/unit-tests/Makefile.am
@@ -95,18 +95,18 @@ test_mono_handle_LDFLAGS = $(test_ldflags)
 
 test_mono_callspec_SOURCES = main.c
 test_mono_callspec_CFLAGS = $(AM_CFLAGS) -DMAIN=test_mono_callspec_main
-test_mono_callspec_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-mono-callspec.lo
+test_mono_callspec_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-mono-callspec.lo -lstdc++
 test_mono_callspec_LDFLAGS = $(test_ldflags)
 test_mono_callspec_DEPENDENCIES = callspec.exe
 
 test_mono_string_SOURCES = main.c
 test_mono_string_CFLAGS = $(test_cflags) -DMAIN=test_mono_string_main
-test_mono_string_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-mono-string.lo
+test_mono_string_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-mono-string.lo -lstdc++
 test_mono_string_LDFLAGS = $(test_ldflags)
 
 test_mono_embed_SOURCES = main.c
 test_mono_embed_CFLAGS = $(test_cflags) -DMAIN=test_mono_embed_main
-test_mono_embed_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-mono-embed.lo
+test_mono_embed_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-mono-embed.lo -lstdc++
 test_mono_embed_LDFLAGS = $(test_ldflags)
 test_mono_embed_DEPENDENCIES = test-embed.exe
 
@@ -117,7 +117,7 @@ test_path_LDFLAGS = $(test_ldflags)
 
 test_embed_invoke_SOURCES = main.c
 test_embed_invoke_CFLAGS = $(test_cflags) -DMAIN=test_mono_embed_invoke_main
-test_embed_invoke_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-embed-invoke.lo
+test_embed_invoke_LDADD = $(test_ldadd) $(mini_libs) $(sgen_libs) libtestlib_la-test-embed-invoke.lo -lstdc++
 test_embed_invoke_LDFLAGS = $(test_ldflags)
 test_embed_invoke_DEPENDENCIES = test-embed-invoke-cs.exe
 
